---
title: "MADRat_Exercise"
author: "David M Chen"
date: "03/12/2020"
output: rmarkdown::github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Learning Objectives

In this exercise, we will look into the MADRat structure for libraries; These libraries do the bulk of the processing of the data that goes in and comes out of the MAgPIE model, and are standardized for consistency. For this exercise, we will work with the 'mrtutorial' package as an example of the mr- package structure. 

Please fork your own branch of mrtutorial from https://github.com/pik-piam/mrtutorial

Then clone this branch locally. 

## 1. Package structure

Directories in the package are automatically generated for the most part. 

You can also create new libraries through RStudio via "New Project --> New Directory --> R Package". 

Important: To make new libraries accessible through the madrat world, they must include the file "madrat.R" in the R folder of the package.  


## 2. MADRaT Functions - Exercise

We will look closesly into the workflow of processing new data sources to be ready for use in the MAgPIE model. Madrat splits this workflow into download, read, correct, convert, and calculate steps, each of which has a specific function wrapper. 


### 2.1 Download function

Note that if direct download not possible, data files can be manually created in the inputdata/sources folder. This is not the preferred implemntation, but in this case, a download function is not necessary. Naming of the source folder must however match the read functions.
Metadata on where the data was obtained, how it was downloaded, etc. should ideally be documented in the download script. For an ideal case, please see downloadTau in the madrat package.

Please open the downloadTutorialWDI R script. 


``` r
library(madrat)

downloadSource("TutorialWDI")

```


### 2.2 Read function

Read functions are the first step in transforming input data into magclass objects. They should be as simple as possible, with most steps of data cleaning, filling in, and transforming reserved for the correct function. The Read function should be able to specify between indicators (subtypes).

Remember that magclass objects are an array with the the spatial dimension in the first dimension, the temporal dimension in the second, and data values in the third dimemsion(s) (3.1, 3.2...).

Now let's look at readTutorialWDI.R. Note here that because of the way WDI downloads it's data, the naming of the data is assumed by madrat to be multiple subdimensions, due to the use of the ".". This is generally to be avoided, to avoid confusing names and dimensions. Let's rena

``` r
x <- readSource("TutorialWDI", subtype="SP.POP.TOTL", convert=FALSE)
```

### 2.3 Convert Function

The convert function will complete the magclass object: For country-level data, all 249 countries represented in MAGPie need to have a value and be in ISO3 country code. toolCountryFill() in the convert function also removesany codes that it can not match. 

Note that here we have omitted a correctSource() function, it is by default OFF but can be implemented via convert="onlycorrect"

Please open convertTutorialWDI.R

``` r
x <- readSource("TutorialWDI", subtype="SP.POP.TOTL", convert=TRUE)
  
```

### 3. calcOutput

Magclass objects are consistent in structure, making calculations easy. The calcOutput wrapper function calls the functions used to transform input data, called as calcOutput("type", "option1", "option2", ...).

ag_gdp() will calculate agricultural gdp as share of total gdp. Let's open this function. 



``` r
ag_gdp <- calcOutput("AgGDP")

```

By default, calcOutput functions will aggregate to the regional level.

After the function is written and built, try it now with the calcAgGDP function. What is Germany's share of Agricultural GDP in 2010? (Germany's ISO3 code is "DEU")

###EXERCISE

Let's imagine that agricultural GDP comes from only 3 sectors: c("grains", "vegetables", "livestock"), for which each contributes 20%, 15%, 65% of ag. GDP respectively. 

Modify the calcAgGDP function so that it includes a 2nd sub-dimension in the 3rd dimension (dim 3.2) detailing the split into the 3 sectors, while keeping Ag_GDP_share in dimension 3.1 

Use new.magpie() to get started.



All functions are saved in the inputdata/cache file after the first run, increasing efficiency. This means that for any updates to functions, the older cached function needs to be deleted. Cache is toggled with setConfig(forcecache=TRUE)
